// ======================= app.js =======================
const express = require("express");
const axios = require("axios");
const app = express();
app.use(express.json());

/**
 * ======================= Logger =======================
 */
async function Log(stack, level, pkg, message) {
  const logPayload = { stack, level, package: pkg, message };

  try {
    const response = await axios.post("http://localhost:4000/logs", logPayload);
    console.log("Log response:", response.data);
    return response.data;
  } catch (err) {
    console.error("Failed to send log:", err.message);
    throw err;
  }
}

/**
 * ======================= Service =======================
 */
async function sampleService() {
  await Log("SampleService", "debug", "DemoModule", "Executing service logic...");
  return { status: "ok" };
}

/**
 * ======================= Controller =======================
 */
async function sampleController(req, res) {
  try {
    await Log("SampleController", "info", "DemoModule", "Handling /test route");
    const result = await sampleService();
    await Log("SampleController", "info", "DemoModule", "Service executed successfully");
    res.json(result);
  } catch (err) {
    await Log("SampleController", "error", "DemoModule", err.message);
    res.status(500).send("Error");
  }
}

/**
 * ======================= Middleware =======================
 */
app.use(async (req, res, next) => {
  await Log("RequestMiddleware", "info", "API", `${req.method} ${req.url} called`);
  next();
});

/**
 * ======================= Routes =======================
 */
app.get("/test", sampleController);

/**
 * ======================= Error Handler =======================
 */
app.use(async (err, req, res, next) => {
  await Log("GlobalErrorHandler", "error", "App", err.message);
  res.status(500).send("Something went wrong");
});

/**
 * ======================= Start Server =======================
 */
app.listen(3000, async () => {
  await Log("ServerStartup", "info", "App", "Server started on port 3000");
  console.log("ðŸš€ Running on http://localhost:3000");
});
